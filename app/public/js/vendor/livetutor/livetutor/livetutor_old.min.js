(function(E,L,f,m){var r=function(ag){return new r.prototype.init(ag);};L.LiveTutor=r;r.prototype={constructor:r,init:function(ah){var ag={dbPath:"https://livetutor.firebaseio.com/Clients/",APIkey:"",sessionID:"",sessionToken:"",fpAPIkey:"",fpPolicy:"",fpSignature:"",maxFiles:4,maxFileSize:(5*1024*1024),acceptFileTypes:".doc,.xls,.ppt,.pdf,.txt,.gif,.jpg,.jpeg,.png,.zip",fpContainer:"modal",id:"",userRole:"",sessionPrice:0,pricePerMinute:0,sessionLength:0,expiringAlert:0,startPaused:false,pauseOnDisconnect:false,countDown:false,maxParticipants:2,idleTimeout:60000,awayTimeout:300000};
r.options=E.extend({},ag,ah);r._on={initialize:null,initialized:null,active:null,pause:null,paused:null,resume:null,close:null,closed:null};r.version="1.1.2";
if(r.options.APIkey!=""){r.sessionsDB=new Firebase(r.options.dbPath+r.options.APIkey+"/Sessions/");if(r.options.id!=""){r.sessionStatusDB=r.sessionsDB.child(r.options.id).child("Status");
if(_isTutor()){r.sessionStatusDB.once("value",function(aj){if(aj.val()===null){r.sessionStatusDB.set(r.options.startPaused?"paused":"initialize");}});}r.sessionStatusDB.on("value",function(aj){r.sessionStatus=aj.val();
if(r._on.hasOwnProperty(r.sessionStatus)){r._on[r.sessionStatus]();}});}r.participants=0;r.idleNow=false;r.idleTimestamp=null;r.idleTimer=null;r.awayNow=false;
r.awayTimestamp=null;r.awayTimer=null;try{if(Prototype){ae();}}catch(ai){}try{if(jQuery){B();}}catch(ai){}}}};r.prototype.init.prototype=r.prototype;r.on=function(ag,ah){if(ag){if(typeof(ag)==="object"){r._on=E.extend({},r._on,ag);
}else{r._on[ag]=ah;}}return r;},r.off=function(ag){if(typeof(ag)==="string"){if(r._on.hasOwnProperty(ag)){r._on[ag]=null;}}else{for(var ag in r._on){r._on[ag]=null;
}}};r.price=function(ag){r.priceDB=r.sessionsDB.child(r.options.id).child("Price");r.priceDB.on("value",function(aj){var ai=0;if(aj.val()===null){if(_isTutor()){r.priceDB.set(ai);
}}else{ai=aj.val();}if(ag){ag(r.options.countDown?r.options.sessionPrice-ai:ai);}});if(_isTutor()){var ah=r.sessionsDB.child(r.options.id).child("Timer");
ah.on("value",function(ai){r.priceDB.once("value",function(aj){r.priceDB.set(Math.floor(ai.val()/60)*r.options.pricePerMinute);});});}return r;},r.timer=function(aj,ag,ai){var ak;
r.sessionTimer=r.sessionsDB.child(r.options.id).child("Timer");r.sessionTimer.on("value",function(al){if(al.val()===null){if(_isTutor()){r.sessionTimer.set(0);
}}else{ak=al.val();if(ak<r.options.sessionLength){if(ak>(r.options.sessionLength-r.options.expiringAlert)){if(ag){ag();}}}else{r.sessionTimer.off();r.sessionStatusDB.set("expired");
r.sessionStatusDB.off();if(ai){ai();}}}if(aj){aj(r.options.countDown?r.options.sessionLength-ak:ak,r.options.sessionLength);}});if(_isTutor()){var ah=L.setInterval(function(){if(r.sessionStatus=="active"){r.sessionTimer.set(ak+(ak<r.options.sessionLength?1:0));
}},1000);}return r;},r.video=function(aj,ai,ah,ag){r.cameraContainer=aj;r.streamContainer=ai;r.onVideoConnected=ah;r.onVideoDisconnected=ag;r.publisher="";
r.videoSession="";r.subscribedStreams=[];TB.setLogLevel(TB.DEBUG);TB.addEventListener("exception",O);return r;},r.testVideo=function(){var ag={};TB.runTests(function(ah){for(i in ah.cat_network.port_access){ag[i]=ah.cat_network.port_access[i].result;
}});return ag;},r.drawingBoard=function(ag){r.drawingDB=r.sessionsDB.child(r.options.id).child("Drawing");r.drawingMode=r.drawingDB.child("Mode");r.drawingUndo=r.drawingDB.child("Undo");
r.drawingRedo=r.drawingDB.child("Redo");r.textX=r.textY=r.mode="";r.undoBufferCount=r.redoBufferCount=0;r.board=ag.RaphBoard();h();return r;},r.fileManager=function(ag,ah){r.filesCallback=ah;
r.filesDB=r.sessionsDB.child(r.options.id).child("Files");filepicker.setKey(r.options.fpAPIkey);r.fU=E(".LT_fileUpload");r.fU.attr({"data-fp-class":"LT_filePicker","data-fp-drag-text":"Click here or drop files to upload","data-fp-store-location":"S3","data-fp-store-access":"public","data-fp-extensions":r.options.acceptFileTypes,"data-fp-container":r.options.fpContainer,"data-fp-store-path":r.options.APIkey+"/"+r.options.id+"/","data-fp-maxSize":r.options.maxFileSize});
r.fU[0].type="filepicker-dragdrop";r.fU[0].onchange=function(ai){E(".LT_filePicker span").get(0).click();r.filesDB.push({file:ai.fpfile,owner:r.userName});
};filepicker.constructWidget(r.fU[0]);r.numFiles=0;E("#LT_maxListedFiles").html(r.options.maxFiles);E(".LT_fl_delete_all").button({icons:{primary:"ui-icon-trash"},text:false});
af();return r;},r.deleteFiles=function(){return u();},r.presence=function(ah,ag){if(ah!=""){r.userName=ah;r.userList=r.sessionsDB.child(r.options.id).child("Presence");
r.userList.once("value",function(ai){r.participants=ai.numChildren();});if(r.participants<r.options.maxParticipants){r.currentStatus="online";r.myStatus=r.userList.child(ah);
r.myStatus.onDisconnect().remove();r.myStatus.on("value",function(ai){if(ai.val()===null){W(r.currentStatus);}});r.userList.on("child_added",function(ai){k(ai,ag);
});r.userList.on("child_changed",function(ai){a(ai,ag);});r.userList.on("child_removed",function(ai){if(r.options.pauseOnDisconnect&&r.sessionStatus=="active"){r.sessionStatusDB.set("pause");
}C(ai,ag);});f.onIdle=function(){W("idle");};f.onAway=function(){W("away");};f.onBack=function(ai,aj){W("online");};D(r.options.idleTimeout);ad(r.options.awayTimeout);
}}return r;},r.chat=function(ag,ai,ah){var aj=0;ai.html("");r.chatDB=r.sessionsDB.child(r.options.id).child("Chat");r.chatDB.on("child_added",function(ak){aj++;
var al=ak.val();T(ag,ai,al.name,al.text,(aj%2)==1);});ah.keypress(function(ak){if(ak.keyCode==13){var al=ah.val();r.chatDB.push({name:r.userName,text:al});
ah.val("");}});return r;},r.request=function(ag){r.sessionStatusDB.set(ag);},r.decline=function(ag){switch(ag){case"pause":r.sessionStatusDB.set("active");
break;case"resume":r.sessionStatusDB.set("paused");break;default:}},r.pause=function(){l();if(_isStudent()){v();Y();}},r.resume=function(){M();if(_isStudent()){S();
af();}},r.quit=function(){b();l();z();Y();A();};_isTutor=function(){return r.options.userRole=="tutor";};_isModerator=function(){return r.options.userRole=="moderator";
};_isStudent=function(){return r.options.userRole=="student";};function M(){r.videoSession=TB.initSession(r.options.sessionID);r.videoSession.addEventListener("sessionConnected",y);
r.videoSession.addEventListener("streamCreated",X);r.videoSession.addEventListener("streamDestroyed",K);r.videoSession.connect(r.options.APIkey,r.options.sessionToken);
}function ab(ag){}function d(ag){}function X(ah){for(var ag=0;ag<ah.streams.length;ag++){var ai=ah.streams[ag];if(ai.connection.connectionId!=r.videoSession.connection.connectionId){N(ai,r.streamContainer);
}}}function K(ah){for(var ag=0;ag<ah.streams.length;ag++){var ai=ah.streams[ag];Q(ai.streamId);}}function ac(ag){}function y(ag){X(ag);var ah={width:"100%",height:"100%"};
E("<div/>").attr("id","LT_videoCamera").appendTo(r.cameraContainer);r.publisher=TB.initPublisher(r.options.APIkey,"LT_videoCamera",ah);r.publisher.addEventListener("accessAllowed",p);
r.publisher.addEventListener("accessDenied",t);r.videoSession.publish(r.publisher);}function q(ag){}function p(ag){if(r.onVideoConnected){r.onVideoConnected(ag);
}}function t(ag){l();}function g(ag){}function N(ah,ag){var aj={width:"100%",height:"100%"};var ai="LT_"+ah.streamId;E("<div/>").attr("id",ai).appendTo(ag);
r.videoSession.subscribe(ah,ai,aj);r.subscribedStreams[ah.streamId]=ah;}function V(){if(r.subscribedStreams.length>0){for(var ag in r.subscribedStreams){Q(r.subscribedStreams[ag].streamId);
}}}function Q(ag){if(ag){if(r.subscribedStreams.length>0&&r.subscribedStreams[ag]){r.videoSession.unsubscribe(r.subscribedStreams[ag]);E("div#LT_"+ag).remove();
r.subscribedStreams.splice(ag,1);}}}function l(){if(r.onVideoDisconnected){r.onVideoDisconnected();}if(r.subscribedStreams.length>0){V();r.publisher.removeEventListener("accessDenied",t);
r.publisher.removeEventListener("accessAllowed",p);r.videoSession.unpublish(r.publisher);r.videoSession.disconnect();r.videoSession.removeEventListener("streamDestroyed",K);
r.videoSession.removeEventListener("streamCreated",X);r.videoSession.removeEventListener("sessionConnected",y);}}function O(ag){l();switch(ag.code){case 1006:case 1008:case 1013:case 1014:if(L.confirm("There was an error while connecting video:\n\n"+ag.title+"\n\n"+ag.message+"\n\nWould you like to retry?")){M();
}break;default:}}function j(ag){r.drawingMode.child("last").set({UUID:r.board.UUID,mode:ag});}function J(ag){if(ag.val().UUID!=r.board.UUID){r.board.setMode(ag.val().mode);
}}function G(ag,ah){if(!ag.canRedo()){r.drawingRedo.remove(ah);}}function s(ag){if(ag.val().UUID!=r.board.UUID){var ah=JSON.parse(ag.val().element);E.each(ah,function(ak,am){var aj=am.shape;
switch(am.command){case"move":var ai,ao,an;switch(aj.type){case"path":var al=aj.transform.replace("t","").split(",");ai=al[0]?al[0]:0;ao=al[1]?al[1]:0;
an={transform:aj.transform};break;case"circle":case"ellipse":ai=aj.attrs.cx;ao=aj.attrs.cy;an={cx:ai,cy:ao};break;default:ai=aj.attrs.x;ao=aj.attrs.y;an={x:ai,y:ao};
}r.board.move(aj.id,ai,ao);F(ag,"");break;case"cut":r.board.cut(aj.id);break;case"clear":r.board.clear();break;default:r.board.fromJSON(ah);F(ag,"");}});
}}function F(ag,ai,ah){if(ag){ag.child("UUID").ref().set(ai,ah);}}function x(ag){if(ag.val().UUID!=r.board.UUID){r.board.undo();F(ag,"");}}function o(ag){if(ag.val().UUID!=r.board.UUID){r.board.redo();
}}function P(ag,ak,ah,aj){var ai=[];ai.push(ah);ag.push({UUID:ak,element:JSON.stringify(ai)},aj);}function n(ag,ah){ag.limit(1).once("child_added",function(ai){ah(ai);
});}function H(ag,ah){n(ag,function(ai){if(ah){ai.ref().remove(ah(E.extend(true,{},ai)));}else{ai.ref().remove();}});}function h(){if(r.board){r.board.on("before_mode_change",function(ag){r.mode=ag.getMode();
return true;}).on("after_mode_change",function(ag){var ah=ag.getMode();if(ah!=r.mode){ag.setMode(ah);}}).on("before_start",function(ag){r.undoBufferCount=ag.undoBuffer.length;
r.redoBufferCount=ag.redoBuffer.length;switch(ag.getMode()){case"text":r.textX=ag.mouseDownX;r.textY=ag.mouseDownY;E("#LT_textDialog").dialog("open");return false;
default:return true;}}).on("after_end",function(ag){if(ag.undoBuffer.length>r.undoBufferCount){G(ag,P(r.drawingUndo,ag.UUID,ag.undoBuffer[ag.undoBuffer.length-1]));
}}).on("before_cut",function(ag){r.undoBufferCount=ag.undoBuffer.length;return true;}).on("after_cut",function(ag){if(ag.undoBuffer.length>r.undoBufferCount){P(r.drawingUndo,ag.UUID,ag.undoBuffer[ag.undoBuffer.length-1]);
}}).on("before_undo",function(ag){r.undoBufferCount=ag.undoBuffer.length;r.redoBufferCount=ag.redoBuffer.length;return true;}).on("after_undo",function(ag){if(ag.redoBuffer.length>r.redoBufferCount){H(r.drawingUndo,P(r.drawingRedo,ag.UUID,ag.redoBuffer[ag.redoBuffer.length-1]));
}}).on("before_redo",function(ag){r.undoBufferCount=ag.undoBuffer.length;return true;}).on("after_redo",function(ag){if(ag.undoBuffer.length>r.undoBufferCount){H(r.drawingRedo,P(r.drawingUndo,ag.UUID,ag.undoBuffer[ag.undoBuffer.length-1]));
}}).on("before_clear",function(ag){r.undoBufferCount=ag.undoBuffer.length;return true;}).on("after_clear",function(ag){if(ag.undoBuffer.length>r.undoBufferCount){P(r.drawingUndo,ag.UUID,ag.undoBuffer[ag.undoBuffer.length-1]);
}});r.drawingUndo.once("value",function(ah){var ai=[];var ag=[];ah.forEach(function(aj){ai.push(aj.name());s(aj);});r.drawingRedo.once("value",function(aj){var al=[];
aj.forEach(function(an){ag.push(an.name());al.push(an);});var am=al.length;if(am>0){for(var ak=0;ak<am;ak++){s(al.pop());}for(var ak=0;ak<am;ak++){r.board.undo();
}r.redoDB=r.drawingRedo.startAt(null,ag[ag.length-1]);}else{r.redoDB=r.drawingRedo;}r.redoDB.on("child_added",function(an){x(an);});});if(ai.length>0){r.undoDB=r.drawingUndo.startAt(null,ai[ai.length-1]);
}else{r.undoDB=r.drawingUndo;}r.undoDB.on("child_added",function(aj){if(aj.val().UUID!=""){s(aj);}else{o(aj);}});r.drawingMode.on("child_added",function(aj){J(aj);
});r.drawingMode.on("child_changed",function(aj){J(aj);});});r.board.enable();}}function v(){if(r.board){if(r.board){r.board.disable();}if(r.undoDB){r.undoDB.off();
}if(r.redoDB){r.redoDB.off();}if(r.drawingMode){r.drawingMode.off();}if(r.drawingRedo){r.drawingRedo.off();}if(r.drawingUndo){r.drawingUndo.off();}if(r.drawingDB){r.drawingDB.off();
}}}function S(){if(r.board){v();r.board.clear();h();}}function z(){v();if(r.board){r.board=null;}}function u(){var ag=[];E("input:checkbox.LT_fileListSelect").each(function(){var ak=(this.checked?E(this).parent().parent().attr("id"):"");
if(ak!=""){ag.push(ak);}});if(ag.length>0){if(confirm("Are you sure that you want to delete selected file(s)?")){var aj;for(var ai=0;ai<=ag.length-1;ai++){var ah=r.filesDB.child(ag[ai]);
ah.child("file").once("value",function(ak){aj=ak.val();});if(!filepicker.remove(aj,function(){ah.remove();},function(ak){alert("There's been an error while deleting the file:\n\n"+aj.filename+"\n\n"+ak);
})){return false;}}}}return true;}function aa(ah){var ag=ah.val();E("#LT_fileList tbody").append("<tr id='"+ah.name()+"'><td><input class='LT_fileListSelect' type='checkbox'/></td><td><a href='"+ag.file.url+"' target='_blank'>"+ag.file.filename+"</a></td><td>"+ag.file.size+"</td><td>"+ag.owner+"</td></tr>");
r.numFiles++;I(r.numFiles);}function e(ag){E("#"+ag).remove();r.numFiles--;I(r.numFiles);}function I(ag){if(ag==0){if(E("#LT_fileList").is(":visible")){E("#LT_fileList").hide();
}E(".LT_filePicker").show();E(".LT_maxFilesReached").hide();}else{if(ag>=r.options.maxFiles){if(!E("#LT_fileList").is(":visible")){E("#LT_fileList").show();
}E(".LT_filePicker").hide();E(".LT_maxFilesReached").show();}else{if(!E("#LT_fileList").is(":visible")){E("#LT_fileList").show();}E(".LT_filePicker").show();
E(".LT_maxFilesReached").hide();}}if(r.filesCallback){r.filesDB.once("value",function(ah){r.filesCallback(ah);});}}function af(){r.filesDB.on("child_added",function(ag){aa(ag);
});r.filesDB.on("child_removed",function(ag){e(ag.name());});I(r.numFiles);}function Y(){r.filesDB.off();I(0);E(".LT_filePicker").hide();}function ae(){var ai=2;
var ag=ai;var ah=E(f);Event.observe(L,"load",function(aj){Event.observe(L,"click",c);Event.observe(L,"mousemove",c);Event.observe(L,"mouseenter",c);Event.observe(L,"scroll",c);
Event.observe(L,"keydown",c);Event.observe(L,"click",c);Event.observe(L,"dblclick",c);});}function B(){var ag=1;var ah=ag;var ai=E(f);ai.ready(function(){ai.mousemove(c);
try{ai.mouseenter(c);}catch(aj){}try{ai.scroll(c);}catch(aj){}try{ai.keydown(c);}catch(aj){}try{ai.click(c);}catch(aj){}try{ai.dblclick(c);}catch(aj){}});
}function D(ag){r.idleTimestamp=new Date().getTime()+ag;if(r.idleTimer!=null){clearTimeout(r.idleTimer);}r.idleTimer=setTimeout(Z,ag+50);}function w(){clearTimeout(r.idleTimer);
}function ad(ag){r.awayTimestamp=new Date().getTime()+ag;if(r.awayTimer!=null){clearTimeout(r.awayTimer);}r.awayTimer=setTimeout(R,ag+50);}function U(){clearTimeout(r.awayTimer);
}function Z(){var ag=new Date().getTime();if(ag<r.idleTimestamp){r.idleTimer=setTimeout(Z,r.idleTimestamp-ag+50);return;}r.idleNow=true;try{if(f.onIdle){f.onIdle();
}}catch(ah){}}function R(){var ag=new Date().getTime();if(ag<r.awayTimestamp){r.awayTimer=setTimeout(R,r.awayTimestamp-ag+50);return;}r.awayNow=true;try{if(f.onAway){f.onAway();
}}catch(ah){}}function c(ai){var ag=new Date().getTime();r.idleTimestamp=ag+r.options.idleTimeout;r.awayTimestamp=ag+r.options.awayTimeout;if(r.idleNow){D(r.options.idleTimeout);
}if(r.awayNow){ad(r.options.awayTimeout);}try{if((r.idleNow||r.awayNow)&&f.onBack){f.onBack(r.idleNow,r.awayNow);}}catch(ah){}r.idleNow=false;r.awayNow=false;
}function b(){w();U();f.onIdle=null;f.onAway=null;f.onBack=null;r.userList.off();r.myStatus.off();r.participants--;r.myStatus.remove();}function W(ag){r.currentStatus=ag;
r.myStatus.set(ag);}function k(ah,ag){if(ah.name()!=r.userName){a(ah,ag);}r.participants=ah.numChildren();}function a(ah,ag){if(ah.name()!=r.userName){switch(ah.val()){case"idle":status="☆ "+ah.name();
break;case"away":status="☄ "+ah.name();break;default:status="★ "+ah.name();}ag.html(status);}}function C(ah,ag){ag.html("- (Offline)");r.participants=ah.numChildren();
}function T(ag,ak,ai,al,ah){var aj=E("<p/>");if(ah){aj.addClass("odd");}aj.text(al).prepend(E("<em/>").text(ai+": ")).appendTo(ak);ag.scrollTop(ak[0].scrollHeight);
}function A(){r.chatDB.off();}})(jQuery,window,document);